<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <title>Manage Users</title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f2f2f2;
            font-weight: bold;
        }
        button.delete-btn {
            background: #e74c3c;
            border: none;
            color: #fff;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
        }
        button.delete-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
<th:block th:replace="~{fragments/menu :: fragment}"></th:block>

<sec:authorize access="hasRole('ADMINISTRATOR')">
    <div class="container">
        <h1>Manage Users</h1>
        <table>
            <thead>
            <tr>
                <th>ID</th><th>Email</th><th>Role</th><th>Name</th><th>Surname</th><th>Birthdate</th><th>Actions</th>
            </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>
        <div id="messageContainer" class="info-message"></div>
    </div>
</sec:authorize>

<sec:authorize access="isAnonymous() or !hasRole('ADMINISTRATOR')">
    <div class="container">
        <h1>Access Denied</h1>
        <p>You do not have permission to view this page. Please <a href="/login">log in</a> as an administrator.</p>
    </div>
</sec:authorize>

<script>
    fetch('http://localhost:8081/users', {credentials:'include'})
        .then(res => res.json())
        .then(users => {
            const usersBody = document.getElementById('usersBody');
            if(!users || users.length === 0) {
                document.getElementById('messageContainer').textContent = "No users found.";
                return;
            }

            users.forEach(user => {
                const tr = document.createElement('tr');

                const idTd = document.createElement('td');
                idTd.textContent = user.id;
                tr.appendChild(idTd);

                const emailTd = document.createElement('td');
                emailTd.textContent = user.email;
                tr.appendChild(emailTd);

                const roleTd = document.createElement('td');
                roleTd.textContent = user.role;
                tr.appendChild(roleTd);

                const nameTd = document.createElement('td');
                nameTd.textContent = user.name;
                tr.appendChild(nameTd);

                const surnameTd = document.createElement('td');
                surnameTd.textContent = user.surname;
                tr.appendChild(surnameTd);

                const birthTd = document.createElement('td');
                birthTd.textContent = user.birthDate ? user.birthDate : 'N/A';
                tr.appendChild(birthTd);

                const actionTd = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteUser(user.id));
                actionTd.appendChild(deleteBtn);
                tr.appendChild(actionTd);

                usersBody.appendChild(tr);
            });
        });

    function deleteUser(userId) {
        if(!confirm("Are you sure you want to delete this user?")) return;
        fetch(`http://localhost:8081/users/${userId}`, {
            method:'DELETE',
            credentials:'include'
        })
            .then(res => {
                if(res.ok) {
                    alert('User deleted successfully');
                    location.reload();
                } else {
                    res.json().then(err => alert(`Failed to delete user: ${err.message}`));
                }
            })
            .catch(err => console.error(err));
    }
</script>
</body>
</html>